define("index:widget/heatLayer/HeatLayer.js",function(t,i,e){function s(t){BMap.TileLayer.call(this,t),this.layerVersion=t.layerVersion,this.uid=t.uid}function n(t){this.tiles=[],this.polygons=[],this.map=t,this.layerVersion=1434,this.layerVersion=15308,this.backupVersion=this.layerVersion}var a="http://1.2-spotinfo.sail.r.bae.baidu.com:8082/getVersion.php",o="http://spotshot.baidu.com/getVersion_n.php",r=["http://shangetu0.map.bdimg.com/it/","http://shangetu1.map.bdimg.com/it/","http://shangetu2.map.bdimg.com/it/","http://shangetu3.map.bdimg.com/it/","http://shangetu4.map.bdimg.com/it/"];s.prototype=new BMap.TileLayer,s.prototype.getTilesUrl=function(t,i){var e=BMap.MapType[this.mapType];if("object"!=typeof e)return null;var s,n=e.baseUnits*Math.pow(2,18-i),a=parseInt(t.lng/n),o=parseInt(t.lat/n);return s=this.uid?r[Math.abs(a+o)%r.length]+"u=x="+a+";y="+o+";z="+i+";v="+this.layerVersion+";type=hot;s="+this.uid+"&fm=44&t="+parseInt((new Date).getTime()/1e3*60*10):r[Math.abs(a+o)%r.length]+"u=x="+a+";y="+o+";z="+i+";v="+this.layerVersion+";type=hot&fm=44&t="+parseInt((new Date).getTime()/1e3*60*10),s.replace(/-(\d+)/gi,"M$1")},$.extend(n.prototype,{init:function(){this._init(),this.bindEvent()},_init:function(){var t=this,i=this.uid?o:a,e=$.ajax(i+"?callback=?",{dataType:"jsonp"});e.done(function(i){t.layerVersion=i.version,t.backupVersion=t.layerVersion}),e.always(function(){t.heatLayer=new s({transparentPng:!0,layerVersion:t.layerVersion,uid:t.uid}),t.map.addTileLayer(t.heatLayer),t.tiles.push(t.heatLayer)})},bindEvent:function(){var t=this;listener.on("index.poi","uid_get",function(i,e){t.resetBounds(),t.setUID(e.uid),t.setBounds(e.point)}),listener.on("common.page","city_change",function(){t.unsetUID(),t.resetBounds()})},setUID:function(t){this.uid=t,this.reset()},unsetUID:function(){this.uid=void 0,this.reset()},setBounds:function(t){for(var i={strokeColor:"#6791e5",strokeWeight:2,strokeOpacity:.9,strokeStyle:"solid",fillColor:"#4673cc",fillOpacity:.2},e=0;e<t.length;e++){var s=t[e].split("|");t[e]=new BMap.Point(s[0],s[1])}var n=new BMap.Polygon(t,i);this.map.addOverlay(n),this.map.setViewport(t),this.polygons.push(n)},resetBounds:function(){for(var t=0;t<this.polygons.length;t++)this.map.removeOverlay(this.polygons[t]);this.polygons=[]},reset:function(){for(var t=0;t<this.tiles.length;t++)this.map.removeTileLayer(this.tiles[t]);this.tiles=[],this._init()},getLayer:function(){return this.heatLayer},updateLayer:function(t){var i=this;this.layerVersion=this.backupVersion-(0>t?0:t);var e=new s({transparentPng:!0,layerVersion:this.layerVersion,uid:this.uid});if(this.map.addTileLayer(e),e.tilesDiv.style.visibility="hidden",this.tiles.push(e),this.tiles.length>2)if($.browser.msie&&$.browser.version<=8)this.tiles[1].tilesDiv.style.visibility="visible",setTimeout(function(){i.map.removeTileLayer(i.tiles.shift())},10);else{this.tiles[1].tilesDiv.style.opacity="0",this.tiles[1].tilesDiv.style.visibility="visible",this.tiles[1].opacity=0,this.tiles[0].opacity=100;var n=setInterval(function(){i.tiles[1]&&(i.tiles[1].opacity+=20,i.tiles[1].tilesDiv.style.opacity=i.tiles[1].opacity/100,i.tiles[0].opacity-=20,i.tiles[0].tilesDiv.style.opacity=i.tiles[0].opacity/100,100==i.tiles[1].opacity&&(clearInterval(n),i.map.removeTileLayer(i.tiles.shift()),0>t&&i.map.removeTileLayer(i.tiles.pop())))},100)}this.heatLayer=this.tiles[0]},setVersion:function(t){this.layerVersion=t},resetVersion:function(){this.layerVersion=this.backupVersion}}),e.exports=n});