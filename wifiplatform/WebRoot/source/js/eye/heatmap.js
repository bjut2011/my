!function(t){var e=function(){var t=function(t){var e={data:[],heatmap:t};this.max=1,this.get=function(t){return e[t]},this.set=function(t,a){e[t]=a}};t.prototype={addDataPoint:function(t,e){if(!(0>t||0>e)){var a=this,i=a.get("heatmap"),n=a.get("data");return n[t]||(n[t]=[]),n[t][e]||(n[t][e]=0),n[t][e]+=arguments.length<3?1:arguments[2],a.set("data",n),a.max<n[t][e]?(i.get("actx").clearRect(0,0,i.get("width"),i.get("height")),void a.setDataSet({max:n[t][e],data:n},!0)):void i.drawAlpha(t,e,n[t][e],!0)}},setDataSet:function(t,e){var a=this,i=a.get("heatmap"),n=[],o=t.data,s=o.length;if(i.clear(),this.max=t.max,i.get("legend")&&i.get("legend").update(t.max),null!=e&&e){for(var r in o)if(void 0!==r)for(var l in o[r])void 0!==l&&i.drawAlpha(r,l,o[r][l],!1)}else for(;s--;){var h=o[s];i.drawAlpha(h.x,h.y,h.count,!1),n[h.x]||(n[h.x]=[]),n[h.x][h.y]||(n[h.x][h.y]=0),n[h.x][h.y]=h.count}i.colorize(),this.set("data",o)},exportDataSet:function(){var t=this,e=t.get("data"),a=[];for(var i in e)if(void 0!==i)for(var n in e[i])void 0!==n&&a.push({x:parseInt(i,10),y:parseInt(n,10),count:e[i][n]});return{max:t.max,data:a}},generateRandomDataSet:function(t){var e=this.get("heatmap"),a=e.get("width"),i=e.get("height"),n={},o=Math.floor(1e3*Math.random()+1);n.max=o;for(var s=[];t--;)s.push({x:Math.floor(Math.random()*a+1),y:Math.floor(Math.random()*i+1),count:Math.floor(Math.random()*o+1)});n.data=s,this.setDataSet(n)}};var e=function(t){this.config=t;var e={element:null,labelsEl:null,gradientCfg:null,ctx:null};this.get=function(t){return e[t]},this.set=function(t,a){e[t]=a},this.init()};e.prototype={init:function(){var t,e,a=this,i=a.config,n=i.title||"Legend",o=i.position,s=i.offset||10,r=(i.gradient,document.createElement("ul")),l="";a.processGradientObject(),l+=o.indexOf("t")>-1?"top:"+s+"px;":"bottom:"+s+"px;",l+=o.indexOf("l")>-1?"left:"+s+"px;":"right:"+s+"px;",t=document.createElement("div"),t.style.cssText="border-radius:5px;position:absolute;"+l+"font-family:Helvetica; width:256px;z-index:10000000000; background:rgba(255,255,255,1);padding:10px;border:1px solid black;margin:0;",t.innerHTML="<h3 style='padding:0;margin:0;text-align:center;font-size:16px;'>"+n+"</h3>",r.style.cssText="position:relative;font-size:12px;display:block;list-style:none;list-style-type:none;margin:0;height:15px;",e=document.createElement("div"),e.style.cssText=["position:relative;display:block;width:256px;height:15px;border-bottom:1px solid black; background-image:url(",a.createGradientImage(),");"].join(""),t.appendChild(r),t.appendChild(e),a.set("element",t),a.set("labelsEl",r),a.update(1)},processGradientObject:function(){var t=this,e=this.config.gradient,a=[];for(var i in e)e.hasOwnProperty(i)&&a.push({stop:i,value:e[i]});a.sort(function(t,e){return t.stop-e.stop}),a.unshift({stop:0,value:"rgba(0,0,0,0)"}),t.set("gradientArr",a)},createGradientImage:function(){var t,e=this,a=e.get("gradientArr"),i=a.length,n=document.createElement("canvas"),o=n.getContext("2d");n.width="256",n.height="15",t=o.createLinearGradient(0,5,256,10);for(var s=0;i>s;s++)t.addColorStop(1/(i-1)*s,a[s].value);o.fillStyle=t,o.fillRect(0,5,256,10),o.strokeStyle="black",o.beginPath();for(var s=0;i>s;s++)o.moveTo((1/(i-1)*s*256>>0)+.5,0),o.lineTo((1/(i-1)*s*256>>0)+.5,0==s?15:5);return o.moveTo(255.5,0),o.lineTo(255.5,15),o.moveTo(255.5,4.5),o.lineTo(0,4.5),o.stroke(),e.set("ctx",o),n.toDataURL()},getElement:function(){return this.get("element")},update:function(t){for(var e,a,i=this,n=i.get("gradientArr"),o=i.get("ctx"),s=i.get("labelsEl"),r="",l=0;l<n.length;l++)e=t*n[l].stop>>0,a=o.measureText(e).width/2>>0,0==l&&(a=0),l==n.length-1&&(a*=2),r+='<li style="position:absolute;left:'+(((1/(n.length-1)*l*256||0)>>0)-a+.5)+'px">'+e+"</li>";s.innerHTML=r}};var a=function(e){var a={radius:40,element:{},canvas:{},acanvas:{},ctx:{},actx:{},legend:null,visible:!0,width:0,height:0,max:!1,gradient:!1,opacity:180,premultiplyAlpha:!1,bounds:{l:1e3,r:0,t:1e3,b:0},debug:!1};this.store=new t(this),this.get=function(t){return a[t]},this.set=function(t,e){a[t]=e},this.configure(e),this.init()};return a.prototype={configure:function(t){var a=this;if(a.set("radius",t.radius||40),a.set("element",t.element instanceof Object?t.element:document.getElementById(t.element)),a.set("visible",null!=t.visible?t.visible:!0),a.set("max",t.max||!1),a.set("gradient",t.gradient||{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"}),a.set("opacity",parseInt(255/(100/t.opacity),10)||180),a.set("width",t.width||0),a.set("height",t.height||0),a.set("debug",t.debug),t.legend){var i=t.legend;i.gradient=a.get("gradient"),a.set("legend",new e(i))}},resize:function(){var t=this,e=t.get("element"),a=t.get("canvas"),i=t.get("acanvas");a.width=i.width=t.get("width")||e.style.width.replace(/px/,"")||t.getWidth(e),this.set("width",a.width),a.height=i.height=t.get("height")||e.style.height.replace(/px/,"")||t.getHeight(e),this.set("height",a.height)},init:function(){var t=this,e=document.createElement("canvas"),a=document.createElement("canvas"),i=e.getContext("2d"),n=a.getContext("2d"),o=t.get("element");t.initColorPalette(),t.set("canvas",e),t.set("ctx",i),t.set("acanvas",a),t.set("actx",n),t.resize(),e.style.cssText=a.style.cssText="position:absolute;top:0;left:0;z-index:10000000;",t.get("visible")||(e.style.display="none"),o.appendChild(e),t.get("legend")&&o.appendChild(t.get("legend").getElement()),t.get("debug")&&document.body.appendChild(a),n.shadowOffsetX=15e3,n.shadowOffsetY=15e3,n.shadowBlur=15},initColorPalette:function(){var t,e,a,i=this,n=document.createElement("canvas"),o=i.get("gradient");n.width="1",n.height="256",t=n.getContext("2d"),e=t.createLinearGradient(0,0,1,256),a=t.getImageData(0,0,1,1),a.data[0]=a.data[3]=64,a.data[1]=a.data[2]=0,t.putImageData(a,0,0),a=t.getImageData(0,0,1,1),i.set("premultiplyAlpha",a.data[0]<60||a.data[0]>70);for(var s in o)e.addColorStop(s,o[s]);t.fillStyle=e,t.fillRect(0,0,1,256),i.set("gradient",t.getImageData(0,0,1,256).data)},getWidth:function(t){var e=t.offsetWidth;return t.style.paddingLeft&&(e+=t.style.paddingLeft),t.style.paddingRight&&(e+=t.style.paddingRight),e},getHeight:function(t){var e=t.offsetHeight;return t.style.paddingTop&&(e+=t.style.paddingTop),t.style.paddingBottom&&(e+=t.style.paddingBottom),e},colorize:function(t,e){var a,i,n,o,s,r,l,h,d,g,p=this,c=p.get("width"),u=p.get("radius"),f=p.get("height"),m=p.get("actx"),x=p.get("ctx"),v=3*u,y=p.get("premultiplyAlpha"),b=p.get("gradient"),w=p.get("opacity"),P=p.get("bounds");null!=t&&null!=e?(t+v>c&&(t=c-v),0>t&&(t=0),0>e&&(e=0),e+v>f&&(e=f-v),a=t,i=e,o=t+v,n=e+v):(a=P.l<0?0:P.l,o=P.r>c?c:P.r,i=P.t<0?0:P.t,n=P.b>f?f:P.b),s=m.getImageData(a,i,o-a,n-i),r=s.data,l=r.length;for(var T=3;l>T;T+=4)h=r[T],d=4*h,d&&(g=w>h?h:w,r[T-3]=b[d],r[T-2]=b[d+1],r[T-1]=b[d+2],y&&(r[T-3]/=255/g,r[T-2]/=255/g,r[T-1]/=255/g),r[T]=g);s.data=r,x.putImageData(s,a,i)},drawAlpha:function(t,e,a,i){var n=this,o=n.get("radius"),s=n.get("actx"),r=(n.get("max"),n.get("bounds")),l=t-1.5*o>>0,h=e-1.5*o>>0,d=t+1.5*o>>0,g=e+1.5*o>>0;s.shadowColor="rgba(0,0,0,"+(a?a/n.store.max:"0.1")+")",s.shadowOffsetX=15e3,s.shadowOffsetY=15e3,s.shadowBlur=15,s.beginPath(),s.arc(t-15e3,e-15e3,o,0,2*Math.PI,!0),s.closePath(),s.fill(),i?n.colorize(l,h):(l<r.l&&(r.l=l),h<r.t&&(r.t=h),d>r.r&&(r.r=d),g>r.b&&(r.b=g))},toggleDisplay:function(){var t=this,e=t.get("visible"),a=t.get("canvas");a.style.display=e?"none":"block",t.set("visible",!e)},getImageData:function(){return this.get("canvas").toDataURL()},clear:function(){var t=this,e=t.get("width"),a=t.get("height");t.store.set("data",[]),t.get("ctx").clearRect(0,0,e,a),t.get("actx").clearRect(0,0,e,a)},cleanup:function(){var t=this;t.get("element").removeChild(t.get("canvas"))}},{create:function(t){return new a(t)},util:{mousePosition:function(t){var e,a;return t.layerX?(e=t.layerX,a=t.layerY):t.offsetX&&(e=t.offsetX,a=t.offsetY),"undefined"!=typeof e?[e,a]:void 0}}}}();t.h337=t.heatmapFactory=e}(window);var BMapLib=window.BMapLib=BMapLib||{};!function(){function t(){var t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))}var e=BMapLib.HeatmapOverlay=function(t){this.conf=t,this.heatmap=null,this.latlngs=[],this.bounds=null};e.prototype=new BMap.Overlay,e.prototype.initialize=function(e){this._map=e;var a=document.createElement("div");return a.style.position="absolute",a.style.top=0,a.style.left=0,a.style.border=0,a.style.width=this._map.getSize().width+"px",a.style.height=this._map.getSize().height+"px",this.conf.element=a,t()?(e.getPanes().mapPane.appendChild(a),this.heatmap=h337.create(this.conf),this._div=a,a):a},e.prototype.draw=function(){if(t()){var e=this._map.getBounds();if(!e.equals(this.bounds)){this.bounds=e;var a=this._map.pointToOverlayPixel(e.getNorthEast()),i=this._map.pointToOverlayPixel(e.getSouthWest()),n=a.y,o=i.x,s=i.y-a.y,r=a.x-i.x;if(this.conf.element.style.left=o+"px",this.conf.element.style.top=n+"px",this.conf.element.style.width=r+"px",this.conf.element.style.height=s+"px",this.heatmap.store.get("heatmap").resize(),this.latlngs.length>0){this.heatmap.clear();var l=this.latlngs.length;for(d={max:this.heatmap.store.max,data:[]};l--;){var h=this.latlngs[l].latlng;if(e.containsPoint(h)){var g=this._map.pointToOverlayPixel(h),p=new BMap.Pixel(g.x-o,g.y-n),c=this.pixelTransform(p);d.data.push({x:c.x,y:c.y,count:this.latlngs[l].c})}}this.heatmap.store.setDataSet(d)}}}},e.prototype.pixelTransform=function(t){for(var e=this.heatmap.get("width"),a=this.heatmap.get("height");t.x<0;)t.x+=e;for(;t.x>e;)t.x-=e;for(;t.y<0;)t.y+=a;for(;t.y>a;)t.y-=a;return t.x=t.x>>0,t.y=t.y>>0,t},e.prototype.setDataSet=function(e){if(this.data=e,t()){var a=this._map.getBounds(),i={max:e.max,data:[]},n=e.data,o=n.length;for(this.latlngs=[];o--;){var s=new BMap.Point(n[o].lng,n[o].lat);if(a.containsPoint(s)){this.latlngs.push({latlng:s,c:n[o].count});var r=this._map.pointToOverlayPixel(s),l=this._map.pointToOverlayPixel(a.getSouthWest()).x,h=this._map.pointToOverlayPixel(a.getNorthEast()).y,d=new BMap.Pixel(r.x-l,r.y-h),g=this.pixelTransform(d);i.data.push({x:g.x,y:g.y,count:n[o].count})}}this.heatmap.clear(),this.heatmap.store.setDataSet(i)}},e.prototype.addDataPoint=function(e,a,i){if(t()){this.data&&this.data.data&&this.data.data.push({lng:e,lat:a,count:i});var n=new BMap.Point(e,a),o=this.pixelTransform(this._map.pointToOverlayPixel(n));this.heatmap.store.addDataPoint(o.x,o.y,i),this.latlngs.push({latlng:n,c:i})}},e.prototype.toggle=function(){t()&&this.heatmap.toggleDisplay()},e.prototype.setOptions=function(e){if(t()&&e){for(var a in e)this.heatmap.set(a,e[a]),"gradient"!=a?"opacity"==a&&this.heatmap.set(a,parseInt(255/(100/e[a]),10)):this.heatmap.initColorPalette();this.data&&this.setDataSet(this.data)}}}();